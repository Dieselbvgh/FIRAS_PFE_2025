name: ğŸ”’ Docker Security Scan & Rebuild Pipeline

on:
  workflow_dispatch:  # Allows manual trigger
  push:
    branches: [ main ]

jobs:
  docker-security-pipeline:
    runs-on: self-hosted
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker
      run: |
        sudo systemctl start docker || true
        sudo usermod -aG docker $USER || true

    - name: ğŸ” Scan Docker Image with Trivy
      run: |
        echo "ğŸ” Scanning nginx:latest for vulnerabilities..."
        
        # Pull the image
        sudo docker pull nginx:latest
        
        # Run Trivy scan and save results
        sudo trivy image --format json nginx:latest > trivy-scan-results.json || echo "Trivy scan completed"
        
        # Count critical vulnerabilities
        CRITICAL_COUNT=$(cat trivy-scan-results.json | grep -o '"Severity":"CRITICAL"' | wc -l || echo "0")
        HIGH_COUNT=$(cat trivy-scan-results.json | grep -o '"Severity":"HIGH"' | wc -l || echo "0")
        
        echo "ğŸ“Š Scan Results: $CRITICAL_COUNT Critical, $HIGH_COUNT High vulnerabilities"
        
        # Track scan in dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d '{
            "status": "scan-completed", 
            "source": "docker-security-pipeline",
            "commit": "'${{ github.sha }}'",
            "version": "scan-${{ github.run_id }}"
          }' || echo "Scan tracking failed"

    - name: ğŸ› ï¸ Auto-Fix & Rebuild Image
      run: |
        echo "ğŸ› ï¸ Starting auto-fix and rebuild..."
        
        # Create a simple hardened Dockerfile
        cat > Dockerfile.hardened << 'EOF'
        FROM nginx:latest
        
        # Security hardening
        RUN apt-get update && apt-get upgrade -y && \
            apt-get clean && \
            rm -rf /var/lib/apt/lists/*
        
        # Remove unnecessary packages
        RUN apt-get remove -y curl wget && \
            apt-get autoremove -y
        
        # Create non-root user
        RUN useradd -r -s /bin/false nginxuser && \
            chown -R nginxuser:nginxuser /var/cache/nginx && \
            chown -R nginxuser:nginxuser /var/log/nginx
        
        USER nginxuser
        
        EXPOSE 80
        EOF
        
        # Build hardened image
        sudo docker build -f Dockerfile.hardened -t nginx-hardened-${{ github.run_id }} .
        
        echo "âœ… Hardened image built: nginx-hardened-${{ github.run_id }}"
        
        # Scan the hardened image to compare
        sudo trivy image --format json nginx-hardened-${{ github.run_id }} > trivy-hardened-results.json || echo "Hardened scan completed"

    - name: ğŸ“Š Compare Results & Track
      run: |
        echo "ğŸ“Š Comparing scan results..."
        
        # Count vulnerabilities in original image
        OLD_CRITICAL=$(cat trivy-scan-results.json | grep -o '"Severity":"CRITICAL"' | wc -l || echo "0")
        OLD_HIGH=$(cat trivy-scan-results.json | grep -o '"Severity":"HIGH"' | wc -l || echo "0")
        
        # Count vulnerabilities in hardened image  
        NEW_CRITICAL=$(cat trivy-hardened-results.json | grep -o '"Severity":"CRITICAL"' | wc -l || echo "0")
        NEW_HIGH=$(cat trivy-hardened-results.json | grep -o '"Severity":"HIGH"' | wc -l || echo "0")
        
        echo "ğŸ¯ VULNERABILITY REDUCTION:"
        echo "  Critical: $OLD_CRITICAL â†’ $NEW_CRITICAL"
        echo "  High: $OLD_HIGH â†’ $NEW_HIGH"
        
        # Track rebuild in dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d '{
            "status": "rebuild-completed", 
            "source": "docker-security-pipeline",
            "commit": "'${{ github.sha }}'",
            "version": "hardened-${{ github.run_id }}",
            "vulnerability_reduction": {
              "critical": '$((OLD_CRITICAL - NEW_CRITICAL))',
              "high": '$((OLD_HIGH - NEW_HIGH))'
            }
          }' || echo "Rebuild tracking failed"

    - name: ğŸ‰ Final Results
      run: |
        echo "=========================================="
        echo "ğŸš€ DOCKER SECURITY PIPELINE COMPLETE!"
        echo "=========================================="
        echo "ğŸ“¦ Original Image: nginx:latest"
        echo "ğŸ›¡ï¸ Hardened Image: nginx-hardened-${{ github.run_id }}"
        echo "ğŸ” Scan results saved to:"
        echo "   - trivy-scan-results.json (original)"
        echo "   - trivy-hardened-results.json (hardened)"
        echo "ğŸ“Š Check your dashboard for deployment tracking!"
        echo "=========================================="
