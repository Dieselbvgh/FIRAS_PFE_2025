name: Scan and Re-build (new_version)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan-rebuild:
    runs-on: self-hosted

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Setup Docker
      run: |
        sudo systemctl start docker
        sleep 2

    - name: ðŸ”‘ Set GH Token
      run: |
        echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

    - name: ðŸ” Scan Original Image
      id: scan-original
      run: |
        IMAGE=node:8-alpine
        sudo docker pull $IMAGE
        sudo grype $IMAGE > grype-original.txt 2>&1 || true
        OLD_CRITICAL=$(grep -c "Critical" grype-original.txt || echo 0)
        OLD_HIGH=$(grep -c "High" grype-original.txt || echo 0)
        echo "OLD_CRITICAL=$OLD_CRITICAL" >> $GITHUB_ENV
        echo "OLD_HIGH=$OLD_HIGH" >> $GITHUB_ENV
        echo "ORIGINAL_IMAGE=$IMAGE" >> $GITHUB_ENV

        # Track in local dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"original-scan\", \"source\": \"security-pipeline\", \"commit\": \"node8-scan\", \"image\": \"$IMAGE\", \"critical_vuln\": $OLD_CRITICAL, \"high_vuln\": $OLD_HIGH}" || echo "Dashboard tracking failed"

    - name: ðŸ› ï¸ Build Hardened Image
      id: build-secure
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        SECURE_IMAGE_NAME=node-secure-$TIMESTAMP
        cat > Dockerfile.secure << 'DOCKERFILE'
FROM node:8-alpine
RUN apk update && apk upgrade --no-cache
RUN apk del curl wget 2>/dev/null || echo "Packages not present"
RUN rm -rf /var/cache/apk/*
RUN addgroup -g 1001 -S appuser && adduser -S appuser -u 1001 -G appuser
USER appuser
DOCKERFILE

        sudo docker build -f Dockerfile.secure -t $SECURE_IMAGE_NAME .
        echo "SECURE_IMAGE_NAME=$SECURE_IMAGE_NAME" >> $GITHUB_ENV
        echo "SECURE_IMAGE=$SECURE_IMAGE_NAME:latest" >> $GITHUB_ENV

    - name: ðŸ” Scan Hardened Image
      id: scan-secure
      run: |
        SECURE_IMAGE="${{ env.SECURE_IMAGE_NAME }}:latest"
        sudo grype $SECURE_IMAGE > grype-secure.txt 2>&1 || true
        NEW_CRITICAL=$(grep -c "Critical" grype-secure.txt || echo 0)
        NEW_HIGH=$(grep -c "High" grype-secure.txt || echo 0)
        echo "NEW_CRITICAL=$NEW_CRITICAL" >> $GITHUB_ENV
        echo "NEW_HIGH=$NEW_HIGH" >> $GITHUB_ENV

    - name: ðŸ“Š Show Final Results
      run: |
        echo "Original Critical: $OLD_CRITICAL, High: $OLD_HIGH"
        echo "Hardened Critical: $NEW_CRITICAL, High: $NEW_HIGH"

        # Track final results in local dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"pipeline-complete\", \"source\": \"security-pipeline\", \"commit\": \"final-results\", \"original_image\": \"$ORIGINAL_IMAGE\", \"secure_image\": \"$SECURE_IMAGE\", \"critical_before\": $OLD_CRITICAL, \"critical_after\": $NEW_CRITICAL}"

    - name: ðŸŸ¢ Create GitHub Deployment
      id: gh-deploy
      uses: octokit/request-action@v5
      with:
        route: POST /repos/Dieselbvgh/FIRAS_PFE_2025/deployments
        ref: main
        environment: production
        description: "Scan & Re-build workflow completed"
        transient_environment: false
        auto_merge: false

    - name: ðŸŸ¢ Set Deployment Status
      uses: octokit/request-action@v5
      with:
        route: POST /repos/Dieselbvgh/FIRAS_PFE_2025/deployments/${{ steps.gh-deploy.outputs.data.id }}/statuses
        state: success
        environment_url: http://localhost:3000
        description: "Security scan & hardened image ready"

    - name: ðŸ§¹ Cleanup
      run: |
        rm -f grype-*.txt Dockerfile.secure || true
        sudo docker rmi node:8-alpine 2>/dev/null || true
