name: ðŸ” Docker Security Scan & Rebuild

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan-rebuild:
    runs-on: self-hosted
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Setup Docker
      run: |
        sudo systemctl start docker
        sleep 2

    - name: ðŸ” Scan Node 14 (Many Vulnerabilities)
      run: |
        echo "ðŸ” Scanning node:14-alpine - this has KNOWN vulnerabilities..."
        sudo docker pull node:14-alpine
        
        # Scan and save to file
        sudo trivy image --format json --scanners vuln --skip-db-update node:14-alpine > scan-original.json 2>&1 || true
        
        # Count vulnerabilities from JSON output
        OLD_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-original.json | wc -l || echo "0")
        OLD_HIGH=$(grep -o '"Severity":"HIGH"' scan-original.json | wc -l || echo "0")
        
        echo "ðŸ“Š ORIGINAL IMAGE: $OLD_CRITICAL Critical, $OLD_HIGH High vulnerabilities"
        
        # Track in dashboard - with proper JSON
        if [ "$OLD_CRITICAL" != "0" ]; then
          curl -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"vulnerability-scan\", \"source\": \"security-scan\", \"commit\": \"${{ github.sha }}\", \"vulnerabilities_original\": $OLD_CRITICAL}" || echo "Tracking failed but continuing"
        fi

    - name: ðŸ› ï¸ Build Secure Version
      run: |
        echo "ðŸ› ï¸ Building hardened version..."
        
        # Create hardened Dockerfile
        cat > Dockerfile.secure << 'DOCKERFILE'
        FROM node:14-alpine
        # Update all packages (this fixes most vulnerabilities)
        RUN apk update && apk upgrade
        # Remove unnecessary packages
        RUN apk del curl wget 2>/dev/null || true
        # Use non-root user
        RUN adduser -D -S appuser
        USER appuser
        DOCKERFILE
        
        sudo docker build -f Dockerfile.secure -t node-secure-$(date +%s) .

    - name: ðŸ” Scan Secure Image
      run: |
        echo "ðŸ” Scanning the hardened image..."
        
        # Find the secure image we just built
        SECURE_IMAGE=$(sudo docker images --format "table {{.Repository}}:{{.Tag}}" | grep node-secure | head -1)
        echo "Scanning: $SECURE_IMAGE"
        
        sudo trivy image --format json --scanners vuln --skip-db-update "$SECURE_IMAGE" > scan-secure.json 2>&1 || true
        
        NEW_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-secure.json | wc -l || echo "0")
        NEW_HIGH=$(grep -o '"Severity":"HIGH"' scan-secure.json | wc -l || echo "0")
        
        echo "ðŸ“Š SECURE IMAGE: $NEW_CRITICAL Critical, $NEW_HIGH High vulnerabilities"

    - name: ðŸ“Š Show Results
      run: |
        # Get the counts again to be safe
        OLD_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-original.json | wc -l || echo "0")
        NEW_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-secure.json | wc -l || echo "0")
        
        REDUCTION=$((OLD_CRITICAL - NEW_CRITICAL))
        
        echo "========================================"
        echo "ðŸŽ‰ SECURITY SCAN RESULTS"
        echo "========================================"
        echo "ðŸ”“ Original: $OLD_CRITICAL Critical vulnerabilities"
        echo "ðŸ”’ Secure:   $NEW_CRITICAL Critical vulnerabilities"
        echo ""
        echo "ðŸ“‰ Reduction: $REDUCTION Critical vulnerabilities fixed!"
        echo "========================================"
        
        # Track final results - with proper JSON escaping
        if [ "$OLD_CRITICAL" != "0" ]; then
          curl -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"security-improved\", \"source\": \"security-scan\", \"commit\": \"${{ github.sha }}\", \"vulnerabilities_before\": $OLD_CRITICAL, \"vulnerabilities_after\": $NEW_CRITICAL, \"vulnerabilities_fixed\": $REDUCTION}" || echo "Final tracking failed"
        else
          echo "No vulnerabilities found to track"
        fi

    - name: ðŸ§¹ Cleanup
      run: |
        rm -f scan-original.json scan-secure.json Dockerfile.secure || true
        echo "Cleanup completed"
