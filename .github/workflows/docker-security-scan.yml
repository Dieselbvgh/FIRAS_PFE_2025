name: ğŸ” Docker Security Scan & Rebuild

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan-rebuild:
    runs-on: self-hosted
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Setup Docker
      run: |
        sudo systemctl start docker
        sleep 2

    - name: ğŸ”„ Update Trivy Database
      run: |
        echo "ğŸ”„ Updating Trivy vulnerability database..."
        sudo trivy image --download-db-only
        echo "âœ… Database update completed"

    - name: ğŸ” Scan VERY OLD Image with Real Vulnerabilities
      run: |
        echo "ğŸ” Scanning node:8-alpine (VERY OLD with known vulnerabilities)..."
        
        # Use VERY old Node.js version that definitely has vulnerabilities
        sudo docker pull node:8-alpine
        
        # Scan and save proper JSON output
        sudo trivy image --format json node:8-alpine > scan-original.json 2>&1
        
        # Debug: Check if file has content
        echo "=== SCAN FILE CONTENT ==="
        head -5 scan-original.json
        echo "=== END SCAN FILE ==="
        
        # Count vulnerabilities using proper JSON parsing
        if [ -s scan-original.json ]; then
          OLD_CRITICAL=$(python3 -c "import json; data=json.load(open('scan-original.json')); print(sum(1 for r in data.get('Results', []) for v in r.get('Vulnerabilities', []) if v.get('Severity') == 'CRITICAL'))" 2>/dev/null || echo "0")
          OLD_HIGH=$(python3 -c "import json; data=json.load(open('scan-original.json')); print(sum(1 for r in data.get('Results', []) for v in r.get('Vulnerabilities', []) if v.get('Severity') == 'HIGH'))" 2>/dev/null || echo "0")
        else
          OLD_CRITICAL=0
          OLD_HIGH=0
        fi
        
        # Set safe defaults
        OLD_CRITICAL=${OLD_CRITICAL:-0}
        OLD_HIGH=${OLD_HIGH:-0}
        
        echo "ğŸ“Š ORIGINAL node:8-alpine:"
        echo "  Critical vulnerabilities: $OLD_CRITICAL"
        echo "  High vulnerabilities: $OLD_HIGH"
        
        # Track in dashboard with SAFE values
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"vulnerability-scan\", \"source\": \"security-scan\", \"commit\": \"scan-start\", \"vulnerabilities_original\": $OLD_CRITICAL}" || echo "Tracking failed but continuing"

    - name: ğŸ› ï¸ Build Secure Version
      run: |
        echo "ğŸ› ï¸ Building hardened version..."
        
        # Create hardened Dockerfile
        cat > Dockerfile.secure << 'DOCKERFILE'
        FROM node:8-alpine
        
        # Update ALL packages
        RUN apk update && apk upgrade --no-cache
        
        # Remove unnecessary packages
        RUN apk del curl wget 2>/dev/null || echo "Packages not present"
        
        # Clean up cache as root
        RUN rm -rf /var/cache/apk/*
        
        # Use non-root user
        RUN addgroup -g 1001 -S appuser && \
            adduser -S appuser -u 1001 -G appuser
            
        # Switch to non-root user
        USER appuser
        DOCKERFILE
        
        sudo docker build -f Dockerfile.secure -t node-secure-$(date +%s) .
        echo "âœ… Hardened image built"

    - name: ğŸ” Scan Secure Image
      run: |
        echo "ğŸ” Scanning the hardened image..."
        
        # Find the secure image
        SECURE_IMAGE=$(sudo docker images --format "table {{.Repository}}:{{.Tag}}" | grep node-secure | head -1)
        echo "Scanning: $SECURE_IMAGE"
        
        sudo trivy image --format json "$SECURE_IMAGE" > scan-secure.json 2>&1
        
        # Count vulnerabilities in hardened image
        if [ -s scan-secure.json ]; then
          NEW_CRITICAL=$(python3 -c "import json; data=json.load(open('scan-secure.json')); print(sum(1 for r in data.get('Results', []) for v in r.get('Vulnerabilities', []) if v.get('Severity') == 'CRITICAL'))" 2>/dev/null || echo "0")
          NEW_HIGH=$(python3 -c "import json; data=json.load(open('scan-secure.json')); print(sum(1 for r in data.get('Results', []) for v in r.get('Vulnerabilities', []) if v.get('Severity') == 'HIGH'))" 2>/dev/null || echo "0")
        else
          NEW_CRITICAL=0
          NEW_HIGH=0
        fi
        
        # Set safe defaults
        NEW_CRITICAL=${NEW_CRITICAL:-0}
        NEW_HIGH=${NEW_HIGH:-0}
        
        echo "ğŸ“Š SECURE IMAGE:"
        echo "  Critical vulnerabilities: $NEW_CRITICAL"
        echo "  High vulnerabilities: $NEW_HIGH"

    - name: ğŸ“Š Show Results
      run: |
        echo "========================================"
        echo "ğŸ‰ SECURITY SCAN RESULTS"
        echo "========================================"
        echo "Image: node:8-alpine"
        echo ""
        echo "ğŸ”“ BEFORE HARDENING:"
        echo "  Critical: $OLD_CRITICAL"
        echo "  High: $OLD_HIGH"
        echo ""
        echo "ğŸ”’ AFTER HARDENING:"
        echo "  Critical: $NEW_CRITICAL"
        echo "  High: $NEW_HIGH"
        echo ""
        
        CRITICAL_REDUCTION=$((OLD_CRITICAL - NEW_CRITICAL))
        HIGH_REDUCTION=$((OLD_HIGH - NEW_HIGH))
        
        echo "ğŸ“‰ VULNERABILITY REDUCTION:"
        echo "  Critical: -$CRITICAL_REDUCTION"
        echo "  High: -$HIGH_REDUCTION"
        
        TOTAL_REDUCTION=$((CRITICAL_REDUCTION + HIGH_REDUCTION))
        
        if [ $TOTAL_REDUCTION -gt 0 ]; then
          echo ""
          echo "âœ… SUCCESS: $TOTAL_REDUCTION vulnerabilities fixed!"
          echo "ğŸ”’ Security hardening effective!"
        elif [ $OLD_CRITICAL -gt 0 ]; then
          echo ""
          echo "âš ï¸  Vulnerabilities found but no reduction"
          echo "ğŸ’¡ Package updates might not fix all issues"
        else
          echo ""
          echo "âŒ NO VULNERABILITIES FOUND"
          echo "ğŸ’¡ Try different older images"
        fi
        echo "========================================"
        
        # Track final results with SAFE values
        if [ -n "$OLD_CRITICAL" ] && [ -n "$NEW_CRITICAL" ]; then
          curl -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"security-scan-complete\", \"source\": \"security-pipeline\", \"commit\": \"scan-done\", \"vulnerabilities_before\": $OLD_CRITICAL, \"vulnerabilities_after\": $NEW_CRITICAL, \"reduction\": $CRITICAL_REDUCTION}" || echo "Final tracking failed"
        else
          echo "Cannot track - vulnerability counts are empty"
        fi

    - name: ğŸ§¹ Cleanup
      run: |
        rm -f scan-original.json scan-secure.json Dockerfile.secure || true
        sudo docker rmi -f $(sudo docker images -q node-secure-*) 2>/dev/null || true
        sudo docker rmi node:8-alpine 2>/dev/null || true
        echo "ğŸ§¹ Cleanup completed"
