name: ğŸ” Docker Security Scan & Rebuild

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan-rebuild:
    runs-on: self-hosted
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Setup Docker
      run: |
        sudo systemctl start docker
        sleep 2

    - name: ğŸ” Scan with Grype (More Reliable)
      run: |
        echo "ğŸ” Scanning node:8-alpine with Grype..."
        
        # Use Grype instead of Trivy - more reliable
        sudo docker pull node:8-alpine
        
        # Scan with Grype and count vulnerabilities
        sudo grype node:8-alpine --output json > grype-scan.json 2>/dev/null || true
        
        # Count vulnerabilities from Grype JSON
        if [ -s grype-scan.json ]; then
          OLD_CRITICAL=$(grep -o '"severity":"Critical"' grype-scan.json | wc -l)
          OLD_HIGH=$(grep -o '"severity":"High"' grype-scan.json | wc -l)
        else
          # Fallback to simple text output counting
          echo "=== TRYING TEXT OUTPUT ==="
          sudo grype node:8-alpine > grype-text.txt 2>&1 || true
          OLD_CRITICAL=$(grep -c "Critical" grype-text.txt || echo "0")
          OLD_HIGH=$(grep -c "High" grype-text.txt || echo "0")
        fi
        
        # Set safe defaults
        OLD_CRITICAL=${OLD_CRITICAL:-0}
        OLD_HIGH=${OLD_HIGH:-0}
        
        echo "ğŸ“Š ORIGINAL node:8-alpine:"
        echo "  Critical vulnerabilities: $OLD_CRITICAL"
        echo "  High vulnerabilities: $OLD_HIGH"
        
        # Also try Trivy as backup
        echo "=== TRIVY BACKUP SCAN ==="
        sudo trivy image node:8-alpine 2>&1 | grep -E "(CRITICAL|HIGH)" | head -10 || echo "No Trivy results"
        
        # Track in dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"vulnerability-scan\", \"source\": \"security-scan\", \"commit\": \"grype-scan\", \"vulnerabilities\": $OLD_CRITICAL}" || echo "Tracking failed"

    - name: ğŸ› ï¸ Build Secure Version
      run: |
        echo "ğŸ› ï¸ Building hardened version..."
        
        cat > Dockerfile.secure << 'DOCKERFILE'
        FROM node:8-alpine
        RUN apk update && apk upgrade --no-cache
        RUN apk del curl wget 2>/dev/null || echo "Packages not present"
        RUN rm -rf /var/cache/apk/*
        RUN addgroup -g 1001 -S appuser && adduser -S appuser -u 1001 -G appuser
        USER appuser
        DOCKERFILE
        
        sudo docker build -f Dockerfile.secure -t node-secure-test .
        echo "âœ… Hardened image built"

    - name: ğŸ” Scan Secure Image with Grype
      run: |
        echo "ğŸ” Scanning hardened image with Grype..."
        
        # Scan hardened image
        sudo grype node-secure-test --output json > grype-secure.json 2>/dev/null || true
        
        # Count vulnerabilities
        if [ -s grype-secure.json ]; then
          NEW_CRITICAL=$(grep -o '"severity":"Critical"' grype-secure.json | wc -l)
          NEW_HIGH=$(grep -o '"severity":"High"' grype-secure.json | wc -l)
        else
          # Fallback to text
          sudo grype node-secure-test > grype-secure-text.txt 2>&1 || true
          NEW_CRITICAL=$(grep -c "Critical" grype-secure-text.txt || echo "0")
          NEW_HIGH=$(grep -c "High" grype-secure-text.txt || echo "0")
        fi
        
        NEW_CRITICAL=${NEW_CRITICAL:-0}
        NEW_HIGH=${NEW_HIGH:-0}
        
        echo "ğŸ“Š SECURE IMAGE:"
        echo "  Critical vulnerabilities: $NEW_CRITICAL"
        echo "  High vulnerabilities: $NEW_HIGH"

    - name: ğŸ“Š Show Final Results
      run: |
        echo "========================================"
        echo "ğŸ‰ SECURITY SCAN RESULTS"
        echo "========================================"
        echo "Scanner: Grype"
        echo "Image: node:8-alpine"
        echo ""
        echo "ğŸ”“ BEFORE HARDENING:"
        echo "  Critical: $OLD_CRITICAL"
        echo "  High: $OLD_HIGH"
        echo ""
        echo "ğŸ”’ AFTER HARDENING:"
        echo "  Critical: $NEW_CRITICAL"
        echo "  High: $NEW_HIGH"
        echo ""
        
        CRITICAL_REDUCTION=$((OLD_CRITICAL - NEW_CRITICAL))
        HIGH_REDUCTION=$((OLD_HIGH - NEW_HIGH))
        
        echo "ğŸ“‰ VULNERABILITY REDUCTION:"
        echo "  Critical: -$CRITICAL_REDUCTION"
        echo "  High: -$HIGH_REDUCTION"
        
        if [ $CRITICAL_REDUCTION -gt 0 ] || [ $HIGH_REDUCTION -gt 0 ]; then
          echo ""
          echo "âœ… SUCCESS: Security improvements achieved!"
          echo "ğŸ”’ Package updates reduced vulnerabilities"
        elif [ $OLD_CRITICAL -gt 0 ]; then
          echo ""
          echo "âš ï¸  Vulnerabilities found but no reduction"
          echo "ğŸ’¡ Some vulnerabilities might not be patchable via package updates"
        else
          echo ""
          echo "âŒ NO VULNERABILITIES DETECTED"
          echo "ğŸ’¡ The scanner might not be working properly"
          echo "ğŸ’¡ Try: sudo grype node:8-alpine"
        fi
        echo "========================================"
        
        # Track results
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"scan-complete\", \"source\": \"grype-scan\", \"commit\": \"final\", \"vuln_before\": $OLD_CRITICAL, \"vuln_after\": $NEW_CRITICAL}" || echo "Tracking failed"

    - name: ğŸ§¹ Cleanup
      run: |
        rm -f grype-*.json grype-*.txt Dockerfile.secure || true
        sudo docker rmi node-secure-test node:8-alpine 2>/dev/null || true
        echo "ğŸ§¹ Cleanup completed"
