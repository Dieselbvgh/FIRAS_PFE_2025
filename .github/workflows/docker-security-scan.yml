name: ğŸ” Docker Security Scan & Rebuild

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan-rebuild:
    runs-on: self-hosted
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Setup Docker
      run: |
        sudo systemctl start docker
        sleep 2

    - name: ğŸ”„ Update Trivy Database
      run: |
        echo "ğŸ”„ Updating Trivy vulnerability database..."
        sudo trivy image --download-db-only
        echo "âœ… Database update completed"

    - name: ğŸ” Scan OLD Apache httpd
      run: |
        echo "ğŸ” Scanning httpd:2.4.46 (Apache 2.4.46 has known CVEs)..."
        
        # Use old Apache httpd version that has vulnerabilities
        sudo docker pull httpd:2.4.46
        
        # Scan and get vulnerability count
        sudo trivy image --format json httpd:2.4.46 > scan-original.json
        
        # Count vulnerabilities properly
        OLD_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-original.json | wc -l)
        OLD_HIGH=$(grep -o '"Severity":"HIGH"' scan-original.json | wc -l)
        OLD_MEDIUM=$(grep -o '"Severity":"MEDIUM"' scan-original.json | wc -l)
        
        # Set default values if empty
        OLD_CRITICAL=${OLD_CRITICAL:-0}
        OLD_HIGH=${OLD_HIGH:-0}
        OLD_MEDIUM=${OLD_MEDIUM:-0}
        
        echo "ğŸ“Š ORIGINAL APACHE httpd:2.4.46:"
        echo "  Critical vulnerabilities: $OLD_CRITICAL"
        echo "  High vulnerabilities: $OLD_HIGH" 
        echo "  Medium vulnerabilities: $OLD_MEDIUM"
        
        # Track in dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"vulnerability-scan\", \"source\": \"security-scan\", \"commit\": \"${{ github.sha }}\", \"vulnerabilities_original\": $OLD_CRITICAL}" || echo "Tracking failed but continuing"

    - name: ğŸ› ï¸ Build Secure Apache Version
      run: |
        echo "ğŸ› ï¸ Building hardened Apache version..."
        
        # Create hardened Dockerfile for Apache
        cat > Dockerfile.secure << 'DOCKERFILE'
        FROM httpd:2.4.46
        
        # Switch to root for package updates
        USER root
        
        # Update ALL packages (Debian-based image)
        RUN apt-get update && apt-get upgrade -y
        
        # Remove unnecessary packages to reduce attack surface
        RUN apt-get remove -y curl wget telnet 2>/dev/null || true
        
        # Clean up
        RUN apt-get autoremove -y && \
            apt-get clean && \
            rm -rf /var/lib/apt/lists/*
        
        # Use non-root user for security
        RUN groupadd -g 1001 appuser && \
            useradd -r -u 1001 -g appuser appuser && \
            chown -R appuser:appuser /usr/local/apache2
        
        # Switch to non-root user
        USER appuser
        
        # Health check
        HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
          CMD curl -f http://localhost/ || exit 1
        DOCKERFILE
        
        sudo docker build -f Dockerfile.secure -t apache-secure-$(date +%s) .
        echo "âœ… Hardened Apache image built"

    - name: ğŸ” Scan Secure Apache Image
      run: |
        echo "ğŸ” Scanning the hardened Apache image..."
        
        # Find the secure image
        SECURE_IMAGE=$(sudo docker images --format "table {{.Repository}}:{{.Tag}}" | grep apache-secure | head -1)
        echo "Scanning: $SECURE_IMAGE"
        
        sudo trivy image --format json "$SECURE_IMAGE" > scan-secure.json
        
        # Count vulnerabilities in hardened image
        NEW_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-secure.json | wc -l)
        NEW_HIGH=$(grep -o '"Severity":"HIGH"' scan-secure.json | wc -l)
        NEW_MEDIUM=$(grep -o '"Severity":"MEDIUM"' scan-secure.json | wc -l)
        
        # Set default values
        NEW_CRITICAL=${NEW_CRITICAL:-0}
        NEW_HIGH=${NEW_HIGH:-0}
        NEW_MEDIUM=${NEW_MEDIUM:-0}
        
        echo "ğŸ“Š SECURE APACHE IMAGE:"
        echo "  Critical vulnerabilities: $NEW_CRITICAL"
        echo "  High vulnerabilities: $NEW_HIGH"
        echo "  Medium vulnerabilities: $NEW_MEDIUM"

    - name: ğŸ“Š Show Results
      run: |
        echo "========================================"
        echo "ğŸ‰ APACHE SECURITY SCAN RESULTS"
        echo "========================================"
        echo "Image: httpd:2.4.46"
        echo ""
        echo "ğŸ”“ BEFORE HARDENING:"
        echo "  Critical: $OLD_CRITICAL"
        echo "  High: $OLD_HIGH"
        echo "  Medium: $OLD_MEDIUM"
        echo ""
        echo "ğŸ”’ AFTER HARDENING:"
        echo "  Critical: $NEW_CRITICAL"
        echo "  High: $NEW_HIGH" 
        echo "  Medium: $NEW_MEDIUM"
        echo ""
        
        CRITICAL_REDUCTION=$((OLD_CRITICAL - NEW_CRITICAL))
        HIGH_REDUCTION=$((OLD_HIGH - NEW_HIGH))
        MEDIUM_REDUCTION=$((OLD_MEDIUM - NEW_MEDIUM))
        
        echo "ğŸ“‰ VULNERABILITY REDUCTION:"
        echo "  Critical: -$CRITICAL_REDUCTION"
        echo "  High: -$HIGH_REDUCTION"
        echo "  Medium: -$MEDIUM_REDUCTION"
        
        TOTAL_REDUCTION=$((CRITICAL_REDUCTION + HIGH_REDUCTION + MEDIUM_REDUCTION))
        
        if [ $TOTAL_REDUCTION -gt 0 ]; then
          echo ""
          echo "âœ… SUCCESS: $TOTAL_REDUCTION vulnerabilities fixed!"
          echo "ğŸ”’ Apache security hardening effective!"
        else
          echo ""
          echo "âš ï¸  No vulnerability reduction detected"
          echo "ğŸ’¡ Trying different older images..."
        fi
        echo "========================================"
        
        # Track final results with safe values
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"security-scan-complete\", \"source\": \"security-pipeline\", \"commit\": \"${{ github.sha }}\", \"vulnerabilities_before\": $OLD_CRITICAL, \"vulnerabilities_after\": $NEW_CRITICAL, \"reduction\": $CRITICAL_REDUCTION}" || echo "Final tracking failed"

    - name: ğŸ§¹ Cleanup
      run: |
        # Remove scan files
        rm -f scan-original.json scan-secure.json Dockerfile.secure || true
        
        # Remove Docker images to save space
        sudo docker rmi -f $(sudo docker images -q apache-secure-*) 2>/dev/null || true
        sudo docker rmi httpd:2.4.46 2>/dev/null || true
        
        echo "ğŸ§¹ Cleanup completed"
