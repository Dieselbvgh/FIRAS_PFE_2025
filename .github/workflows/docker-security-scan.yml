name: üîç Docker Security Scan & Rebuild

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan-rebuild:
    runs-on: self-hosted
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Setup Docker
      run: |
        sudo systemctl start docker
        sleep 2

    - name: üîÑ Update Trivy Database
      run: |
        echo "üîÑ Updating Trivy vulnerability database..."
        sudo trivy image --download-db-only
        echo "‚úÖ Database update completed"

    - name: üîç Scan KNOWN Vulnerable Image
      run: |
        echo "üîç Scanning vulnerable/httpd:2.4.46 - this has KNOWN CVEs..."
        
        # Use a known vulnerable image
        sudo docker pull vulnerable/httpd:2.4.46
        
        # Scan with full database
        sudo trivy image --format json vulnerable/httpd:2.4.46 > scan-original.json
        
        # Count vulnerabilities from JSON
        OLD_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-original.json | wc -l)
        OLD_HIGH=$(grep -o '"Severity":"HIGH"' scan-original.json | wc -l)
        OLD_MEDIUM=$(grep -o '"Severity":"MEDIUM"' scan-original.json | wc -l)
        
        echo "üìä ORIGINAL IMAGE: $OLD_CRITICAL Critical, $OLD_HIGH High, $OLD_MEDIUM Medium vulnerabilities"
        
        # Track in dashboard
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"vulnerability-scan\", \"source\": \"security-scan\", \"commit\": \"${{ github.sha }}\", \"vulnerabilities_original\": $OLD_CRITICAL}" || echo "Tracking failed but continuing"

    - name: üõ†Ô∏è Build Secure Version
      run: |
        echo "üõ†Ô∏è Building hardened version..."
        
        # Create hardened Dockerfile for httpd
        cat > Dockerfile.secure << 'DOCKERFILE'
        FROM vulnerable/httpd:2.4.46
        # Update packages (this image uses apt)
        RUN apt-get update && apt-get upgrade -y
        # Remove unnecessary packages
        RUN apt-get remove -y curl wget telnet 2>/dev/null || true
        # Clean up
        RUN apt-get clean && rm -rf /var/lib/apt/lists/*
        DOCKERFILE
        
        sudo docker build -f Dockerfile.secure -t httpd-secure-$(date +%s) .

    - name: üîç Scan Secure Image
      run: |
        echo "üîç Scanning the hardened image..."
        
        # Find the secure image
        SECURE_IMAGE=$(sudo docker images --format "table {{.Repository}}:{{.Tag}}" | grep httpd-secure | head -1)
        echo "Scanning: $SECURE_IMAGE"
        
        sudo trivy image --format json "$SECURE_IMAGE" > scan-secure.json
        
        NEW_CRITICAL=$(grep -o '"Severity":"CRITICAL"' scan-secure.json | wc -l)
        NEW_HIGH=$(grep -o '"Severity":"HIGH"' scan-secure.json | wc -l)
        NEW_MEDIUM=$(grep -o '"Severity":"MEDIUM"' scan-secure.json | wc -l)
        
        echo "üìä SECURE IMAGE: $NEW_CRITICAL Critical, $NEW_HIGH High, $NEW_MEDIUM Medium vulnerabilities"

    - name: üìä Show Results
      run: |
        echo "========================================"
        echo "üéâ SECURITY SCAN RESULTS"
        echo "========================================"
        echo "üîì Original: $OLD_CRITICAL Critical vulnerabilities"
        echo "üîí Secure:   $NEW_CRITICAL Critical vulnerabilities"
        
        REDUCTION=$((OLD_CRITICAL - NEW_CRITICAL))
        echo ""
        echo "üìâ Reduction: $REDUCTION Critical vulnerabilities fixed!"
        
        if [ $REDUCTION -gt 0 ]; then
          echo "‚úÖ SUCCESS: Security improvements achieved!"
        else
          echo "‚ö†Ô∏è  No vulnerability reduction detected"
          echo "üí° This might be because the image is already patched"
        fi
        echo "========================================"
        
        # Track final results
        curl -X POST http://localhost:3000/api/deployments/track \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"security-improved\", \"source\": \"security-scan\", \"commit\": \"${{ github.sha }}\", \"vulnerabilities_before\": $OLD_CRITICAL, \"vulnerabilities_after\": $NEW_CRITICAL, \"vulnerabilities_fixed\": $REDUCTION}" || echo "Final tracking failed"

    - name: üßπ Cleanup
      run: |
        rm -f scan-original.json scan-secure.json Dockerfile.secure || true
        echo "Cleanup completed"
