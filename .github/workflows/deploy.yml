name: ğŸš€ Deploy DevSecOps Dashboard

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan every Monday 2 AM

env:
  NODE_VERSION: '18.x'

jobs:
  security:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scan
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
    
    - name: Check for secrets
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: .gitleaks.toml

  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests
    needs: security
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    - run: npm ci
    - run: node -c server.js
    - run: |
        echo "ğŸ“ File Structure Check:"
        ls -la
        test -f server.js && echo "âœ… server.js"
        test -f package.json && echo "âœ… package.json" 
        test -f public/index.html && echo "âœ… index.html"
        test -f public/js/dashboard.js && echo "âœ… dashboard.js"

  docker:
    runs-on: ubuntu-latest
    name: ğŸ³ Docker Build
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    - name: Build Docker image
      run: |
        docker build -t devsecops-dashboard:${{ github.sha }} .
        docker images | grep devsecops-dashboard
    - name: Test Docker image
      run: |
        docker run -d --name test-dashboard -p 5002:5001 devsecops-dashboard:${{ github.sha }}
        sleep 10
        curl -f http://localhost:5002/health && echo "âœ… Docker test PASSED" || echo "âŒ Docker test FAILED"
        docker stop test-dashboard
        docker rm test-dashboard

  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production
    needs: [test, docker]
    if: github.ref == 'refs/heads/main'
    
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          echo "ğŸ¯ STARTING DEPLOYMENT..."
          echo "ğŸ• $(date)"
          
          cd /home/ubuntu/FIRAS_PFE_2025
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production
          
          echo "ğŸ”§ Restarting service..."
          sudo systemctl stop devsecops-dashboard || true
          sleep 2
          sudo systemctl start devsecops-dashboard
          sleep 5
          
          echo "ğŸ§ª Running health checks..."
          curl -f http://localhost:5001/health && echo "âœ… Health check PASSED"
          curl -f http://localhost:5001/api/overview && echo "âœ… API check PASSED"
          
          echo " "
          echo "ğŸ‰ DEPLOYMENT COMPLETED!"
          echo "ğŸŒ Dashboard: http://${{ secrets.SERVER_HOST }}:5001"
          echo "ğŸ“Š Run: sudo systemctl status devsecops-dashboard"

  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify
    needs: deploy
    if: always()
    
    steps:
    - name: Deployment Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "ğŸš€ New version deployed to production"
          echo "ğŸ“… $(date)"
        else
          echo "âŒ DEPLOYMENT FAILED"
          echo "ğŸ”§ Check GitHub Actions for details"
        fi
