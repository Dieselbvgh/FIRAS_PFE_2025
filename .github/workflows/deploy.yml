name: ğŸš€ Docker Security Test, Build & Deploy

on:
  push:
    branches: [ main ]
  schedule:
    # Weekly security scan every Monday at 06:00 UTC
    - cron: '0 6 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ§ª Run npm security audit
      run: |
        echo "Running npm security audit..."
        npm audit --audit-level moderate || true

  docker-build:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ³ Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ğŸ³ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-dashboard:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-dashboard:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NODE_ENV=production

  test:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Syntax check
      run: node -c server.js && echo "âœ… Server syntax OK"
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci

  deploy:
    runs-on: self-hosted
    needs: [security-scan, docker-build, test]
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Pull latest Docker image
      run: |
        echo "ğŸ“¥ Pulling latest Docker image..."
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/devsecops-dashboard:latest || echo "Image not found in registry, will build locally"

    - name: ğŸš€ Deploy with Docker Compose
      run: |
        echo "ğŸš€ Starting deployment..."
        cd /home/ubuntu/FIRAS_PFE_2025
        
        echo "ğŸ“¦ Stopping existing containers..."
        docker-compose down
        
        echo "ğŸ³ Pulling latest images..."
        docker-compose pull
        
        echo "ğŸš€ Starting services..."
        docker-compose up -d
        
        echo "â³ Waiting for services to start..."
        sleep 10
        
        echo "ğŸ” Checking application health..."
        MAX_RETRIES=10
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f http://localhost:5001/health; then
            echo "=== âœ… DOCKER DEPLOYMENT SUCCESS! ==="
            echo "ğŸŒ Dashboard: http://localhost:5001"
            echo "ğŸ“Š Application is running successfully!"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "â³ Health check failed, retrying... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 5
          fi
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "=== âŒ DEPLOYMENT FAILED - Health check timeout ==="
          echo "ğŸ“‹ Checking container logs..."
          docker-compose logs
          exit 1
        fi

    - name: ğŸ“Š Show deployment status
      run: |
        echo "ğŸ³ Running containers:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        echo "ğŸ“ˆ Container resource usage:"
        docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -5

    - name: ğŸ§¹ Clean up old images
      run: |
        echo "ğŸ§¹ Cleaning up unused Docker resources..."
        docker image prune -f
        docker system prune -f --volumes
