name: ğŸš€ Deploy DevSecOps Dashboard

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    - run: npm ci
    - run: node -c server.js && echo "âœ… Server syntax OK"
    - run: |
        test -f server.js && echo "âœ… server.js exists"
        test -f package.json && echo "âœ… package.json exists"

  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production
    needs: test
    if: github.ref == 'refs/heads/main'
    
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          echo "ğŸš€ STARTING DEPLOYMENT..."
          echo "ğŸ“… $(date)"
          
          cd /home/ubuntu/FIRAS_PFE_2025
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production
          
          echo "ğŸ”§ Ensuring clean restart..."
          sudo systemctl stop devsecops-dashboard || true
          sudo pkill -f "node server.js" || true
          sleep 3
          
          echo "ğŸ”„ Starting service..."
          sudo systemctl start devsecops-dashboard
          
          echo "â³ Waiting for service..."
          sleep 10
          
          echo "ğŸ§ª Testing deployment..."
          if curl -f http://localhost:5001/health; then
            echo "ğŸ‰ DEPLOYMENT SUCCESS!"
            echo "ğŸŒ Dashboard: http://${{ secrets.SERVER_HOST }}:5001"
          else
            echo "âŒ Deployment failed - checking logs..."
            sudo journalctl -u devsecops-dashboard -n 20 --no-pager
            exit 1
          fi

  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Status
    needs: deploy
    if: always()
    steps:
    - name: Show Result
      run: |
        echo "ğŸ DEPLOYMENT RESULT: ${{ needs.deploy.result }}"
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ SUCCESS! Dashboard updated!"
          echo "ğŸ”— http://${{ secrets.SERVER_HOST }}:5001"
        else
          echo "âŒ Deployment failed - check logs above"
        fi
