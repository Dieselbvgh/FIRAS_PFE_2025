name: ğŸš€ Deploy DevSecOps Dashboard

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    - run: npm ci
    - run: node -c server.js && echo "âœ… Server syntax OK"
    - run: |
        test -f server.js && echo "âœ… server.js exists"
        test -f package.json && echo "âœ… package.json exists"

  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy via Webhook
    needs: test
    if: github.ref == 'refs/heads/main'
    
    environment: production
    
    steps:
    - name: Trigger Deployment Webhook
      run: |
        curl -X POST \
          http://${{ secrets.SERVER_HOST }}:5001/api/deploy \
          -H "Content-Type: application/json" \
          -d '{"secret":"${{ secrets.DEPLOY_SECRET }}"}' \
          --max-time 10 \
          --retry 2 \
          --retry-delay 5 || echo "âš ï¸ Webhook call completed (deployment in progress)"

    - name: Wait for Deployment
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 30

    - name: Verify Deployment
      run: |
        echo "ğŸ§ª Verifying deployment..."
        for i in {1..10}; do
          if curl -f http://${{ secrets.SERVER_HOST }}:5001/health; then
            echo "âœ… DEPLOYMENT SUCCESS!"
            echo "ğŸŒ Dashboard: http://${{ secrets.SERVER_HOST }}:5001"
            exit 0
          fi
          echo "â° Waiting... ($i/10)"
          sleep 5
        done
        echo "âŒ Deployment verification failed"
        exit 1

  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Status
    needs: deploy
    if: always()
    steps:
    - name: Show Result
      run: |
        echo "ğŸ DEPLOYMENT RESULT: ${{ needs.deploy.result }}"
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ SUCCESS! Auto-deployment working!"
          echo "ğŸ”— http://${{ secrets.SERVER_HOST }}:5001"
          echo "ğŸš€ Your CI/CD pipeline is now PRODUCTION READY!"
        else
          echo "âŒ Deployment failed"
          echo "ğŸ”§ Check network connectivity"
        fi
