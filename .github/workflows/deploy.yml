name: Deploy DevSecOps Dashboard

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check server.js syntax
      run: node -c server.js
    
    - name: Verify project structure
      run: |
        echo "‚úÖ Checking project structure..."
        test -f server.js && echo "‚úÖ server.js exists"
        test -f package.json && echo "‚úÖ package.json exists"
        test -d public && echo "‚úÖ public directory exists"
        test -f public/index.html && echo "‚úÖ index.html exists"
        test -f public/js/dashboard.js && echo "‚úÖ dashboard.js exists"
        test -f public/css/style.css && echo "‚úÖ style.css exists"
        echo "‚úÖ All essential files verified!"

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t devsecops-dashboard:latest .
        docker images devsecops-dashboard

  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Create deployment package
      run: |
        mkdir -p deployment
        echo "üì¶ Creating deployment package..."
        # Copy essential files
        cp -r server.js package.json public deployment/
        
        # Copy optional files if they exist
        test -d data && cp -r data deployment/ || echo "‚ö†Ô∏è data directory not found"
        test -d logs && cp -r logs deployment/ || echo "‚ö†Ô∏è logs directory not found"
        test -f .env.example && cp .env.example deployment/ || echo "‚ö†Ô∏è .env.example not found"
        test -d .github && cp -r .github deployment/ || echo "‚ö†Ô∏è .github directory not found"
        
        cd deployment
        echo "üì¶ Deployment package contents:"
        ls -la
        tar -czf ../devsecops-dashboard.tar.gz .
        echo "‚úÖ Package created: devsecops-dashboard.tar.gz"
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: devsecops-dashboard
        path: devsecops-dashboard.tar.gz
        retention-days: 30
    
    - name: Show deployment info
      run: |
        echo "üöÄ Ready for deployment!"
        echo "Repository: https://github.com/Dieselbvgh/FIRAS_PFE_2025"
        echo "To deploy manually, set up GitHub Secrets:"
        echo "1. SERVER_HOST - Your server IP"
        echo "2. SERVER_USER - Your server username"
        echo "3. SERVER_SSH_KEY - Your SSH private key"
        echo ""
        echo "üìä Pipeline Status: ‚úÖ SUCCESS"
