name: ðŸš€ Docker Security Test & Deploy

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: 0  # Don't fail on vulnerabilities

  deploy:
    runs-on: self-hosted
    needs: security-scan
    timeout-minutes: 3
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸš€ Fast Deploy to Host System
      run: |
        set -e  # Exit on any error
        
        echo "ðŸš€ Starting FAST deployment..."
        cd /home/ubuntu/FIRAS_PFE_2025
        
        echo "ðŸ“¦ Quick code update..."
        git fetch origin
        git reset --hard origin/main
        
        echo "ðŸ“¦ Installing dependencies (if needed)..."
        npm ci --only=production
        
        echo "ðŸ”„ Quick application restart..."
        # Use PM2 instead of systemd for faster restarts
        pm2 stop devsecops-dashboard 2>/dev/null || true
        sleep 2
        pm2 start server.js --name devsecops-dashboard --update-env
        sleep 5
        
        echo "ðŸ” Quick health check..."
        if curl -s --max-time 10 http://localhost:3000/health > /dev/null; then
          echo "=== âœ… DEPLOYMENT SUCCESS ==="
          
          # Quick deployment tracking
          curl -s --max-time 5 -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d '{"status": "success", "source": "github-actions", "commit": "'${{ github.sha }}'"}' || \
          echo "âš ï¸ Tracking failed but deployment succeeded"
        else
          echo "=== âŒ DEPLOYMENT FAILED ==="
          # Start anyway and track failure
          pm2 start server.js --name devsecops-dashboard 2>/dev/null || true
          curl -s -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d '{"status": "failed", "source": "github-actions", "commit": "'${{ github.sha }}'"}' || true
          exit 1
        fi
