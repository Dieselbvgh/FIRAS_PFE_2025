name: ğŸš€ Docker Security Test & Deploy

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'

  deploy:
    runs-on: self-hosted
    needs: security-scan
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Host System
      run: |
        echo "ğŸš€ Starting deployment to host system..."
        cd /home/ubuntu/FIRAS_PFE_2025
        
        echo "ğŸ“¦ Pulling latest code..."
        git pull origin main
        
        echo "ğŸ“¦ Installing dependencies..."
        npm install
        
        echo "ğŸ”„ Restarting application..."
        sudo systemctl restart devsecops-dashboard
        
        echo "â³ Waiting for application to start..."
        sleep 15
        
        echo "ğŸ” Checking application health..."
        if curl -f http://localhost:3000/health; then
          echo "=== âœ… DEPLOYMENT SUCCESS! ==="
          echo "ğŸŒ Dashboard: http://localhost:3000"
          
          # Wait a bit more to ensure dashboard is fully ready
          sleep 5
          
          # Track deployment in dashboard with better error handling
          echo "ğŸ“Š Tracking deployment in dashboard..."
          if curl -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d '{"status": "success", "source": "github-actions", "commit": "'${{ github.sha }}'", "version": "1.0.0"}'; then
            echo "âœ… Deployment tracked successfully!"
          else
            echo "âš ï¸ Deployment tracking failed, but deployment was successful"
          fi
        else
          echo "=== âŒ DEPLOYMENT FAILED ==="
          # Track failed deployment
          curl -X POST http://localhost:3000/api/deployments/track \
            -H "Content-Type: application/json" \
            -d '{"status": "failed", "source": "github-actions", "commit": "'${{ github.sha }}'", "version": "1.0.0"}' || true
          sudo journalctl -u devsecops-dashboard --lines=20
          exit 1
        fi
