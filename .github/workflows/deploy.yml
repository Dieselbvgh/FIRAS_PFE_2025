name: ğŸš€ Deploy DevSecOps Dashboard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # Weekly security scan on Monday 2 AM

env:
  NODE_VERSION: '18.x'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scan
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
    
    - name: Check for secrets in code
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  quality-check:
    runs-on: ubuntu-latest
    name: ğŸ“Š Code Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npx eslint server.js public/js/dashboard.js --no-eslintrc --config='{"extends":"eslint:recommended","env":{"browser":true,"node":true}}' || echo "ESLint not configured"
    
    - name: Check code formatting
      run: |
        npx prettier --check server.js public/js/dashboard.js public/css/style.css public/index.html || echo "Prettier not configured"
    
    - name: Validate HTML
      run: |
        npx html-validate public/index.html || echo "HTML validation not configured"

  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests
    needs: [security-scan, quality-check]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Verify project structure
      run: |
        echo "ğŸ” Project Structure Verification"
        files=("server.js" "package.json" "public/index.html" "public/js/dashboard.js" "public/css/style.css")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file - MISSING"
            exit 1
          fi
        done
        echo "ğŸ¯ All essential files present!"
    
    - name: Syntax check
      run: |
        node -c server.js
        echo "âœ… Server syntax OK"
    
    - name: API smoke test
      run: |
        timeout 10s npm start &
        sleep 5
        curl -f http://localhost:5001/health && echo "âœ… Health check passed" || echo "âš ï¸ Health check failed"
        curl -f http://localhost:5001/api/overview && echo "âœ… API overview accessible" || echo "âš ï¸ API overview failed"

  docker-build:
    runs-on: ubuntu-latest
    name: ğŸ³ Docker Build
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t devsecops-dashboard:latest .
        docker images devsecops-dashboard
    
    - name: Scan Docker image
      run: |
        docker scan devsecops-dashboard:latest || echo "Docker scan not available"

  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main'
    
    environment: production
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Create deployment package
      run: |
        mkdir -p deployment
        echo "ğŸ“¦ Creating deployment package..."
        
        # Essential files
        cp -r server.js package.json public deployment/
        
        # Optional files
        [ -d data ] && cp -r data deployment/ || mkdir deployment/data
        [ -d logs ] && cp -r logs deployment/ || mkdir deployment/logs
        [ -f .env.example ] && cp .env.example deployment/ || echo "PORT=5001" > deployment/.env
        
        cd deployment
        echo "ğŸ“ Package contents:"
        find . -type f -name "*.js" -o -name "*.html" -o -name "*.css" -o -name "*.json"
        tar -czf ../devsecops-dashboard.tar.gz .
        echo "âœ… Deployment package ready"
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: devsecops-dashboard-v${{ github.run_number }}
        path: devsecops-dashboard.tar.gz
        retention-days: 30
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          cd /opt
          sudo systemctl stop devsecops-dashboard || true
          [ -d devsecops-dashboard ] && cd devsecops-dashboard && git pull origin main || git clone https://github.com/Dieselbvgh/FIRAS_PFE_2025.git devsecops-dashboard
          cd devsecops-dashboard
          npm install --production
          sudo systemctl daemon-reload
          sudo systemctl start devsecops-dashboard
          sudo systemctl status devsecops-dashboard
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Dashboard available at: http://${{ secrets.SERVER_HOST }}:5001"

  notification:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notifications
    needs: deploy
    if: always()
    
    steps:
    - name: Send Slack notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: ğŸš€ Deployment ${{ job.status }} for FIRAS_PFE_2025
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always() && github.ref == 'refs/heads/main'
