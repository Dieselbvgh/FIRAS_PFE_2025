name: ğŸš€ Deploy DevSecOps Dashboard

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - run: node -c server.js && echo "âœ… Server syntax OK"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "=== ğŸš€ STARTING DEPLOYMENT ==="
          cd ~/FIRAS_PFE_2025
          
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          
          echo "ğŸ”§ Setting up environment..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "ğŸ”„ Restarting application with PM2..."
          /usr/bin/pm2 reload devsecops-dashboard --update-env
          
          echo "â³ Waiting for restart..."
          sleep 8
          
          echo "ğŸ” Checking application status..."
          if curl -f http://localhost:3000/health; then
            echo "=== âœ… DEPLOYMENT SUCCESS! ==="
            echo "ğŸŒ Dashboard: http://localhost:3000"
            echo "ğŸ“Š PM2 Status:"
            /usr/bin/pm2 status
          else
            echo "=== âŒ DEPLOYMENT FAILED ==="
            echo "ğŸ“‹ Checking PM2 logs..."
            /usr/bin/pm2 logs --lines 10
            exit 1
          fi
