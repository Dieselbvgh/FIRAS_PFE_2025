name: ğŸš€ Docker Security Test & Deploy

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'

    - name: ğŸ§ª Run npm security audit
      run: |
        echo "Running npm security audit..."
        npm audit --audit-level moderate || true

  test:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Syntax check
      run: node -c server.js && echo "âœ… Server syntax OK"

  deploy:
    runs-on: self-hosted  # â† THIS IS THE KEY LINE!
    needs: [security-scan, test]
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Build and deploy with Docker
      run: |
        echo "ğŸš€ Starting deployment..."
        cd /home/ubuntu/FIRAS_PFE_2025
        
        echo "ğŸ³ Building Docker image..."
        docker build -t devsecops-dashboard:latest .
        
        echo "ğŸ“¦ Stopping existing containers..."
        docker-compose down || true
        
        echo "ğŸš€ Starting services..."
        docker-compose up -d
        
        echo "â³ Waiting for services to start..."
        sleep 15
        
        echo "ğŸ” Checking application health..."
        MAX_RETRIES=10
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f http://localhost:3000/health; then
            echo "=== âœ… DEPLOYMENT SUCCESS! ==="
            echo "ğŸŒ Dashboard: http://localhost:3000"
            echo "ğŸ“Š Application is running successfully!"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "â³ Health check failed, retrying... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 5
          fi
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "=== âŒ DEPLOYMENT FAILED - Health check timeout ==="
          echo "ğŸ“‹ Checking container logs..."
          docker-compose logs
          exit 1
        fi

    - name: ğŸ“Š Show deployment status
      run: |
        echo "ğŸ³ Running containers:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

    - name: ğŸ§¹ Clean up old images
      run: |
        echo "ğŸ§¹ Cleaning up unused Docker resources..."
        docker image prune -f
